<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>힙합 랭겜 추첨기</title>
  <link rel="icon" href="./assets/favicon.ico">
  <style>
    :root{ --maxw:1720px; --card-w:380px; --box-w:240px; --box-h:220px; }
    html,body{margin:0;padding:0;background:transparent !important;overflow:hidden}
    body{font-family:Arial,system-ui,"Noto Sans KR","Malgun Gothic",sans-serif;font-size:18px;text-align:center}
    h2{margin:10px 0 6px}
    #status{min-height:22px;margin:6px 0 2px}
    .status-ok{color:#1a7f37}.status-err{color:#c62828}
    #meta{font-size:13px;color:#666;min-height:18px;margin-bottom:14px}

    .actions{margin:6px 0 12px;}
    .btn{appearance:none;border:1px solid #d0d7de;background:#fff;border-radius:8px;padding:10px 14px;font-size:14px;cursor:pointer}
    .btn:hover{background:#f6f8fa}

    .grid{max-width:var(--maxw);margin:6px auto;display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
    .card{max-width:var(--card-w);margin:0 auto}
    .title{font-weight:800;font-size:20px;margin-bottom:4px;display:flex;gap:8px;justify-content:center;align-items:center;cursor:pointer;user-select:none}
    .title:hover{opacity:.85}
    .sub{font-size:.9em;color:#555}
    .count{font-size:16px;margin:0 0 6px}
    .box{width:var(--box-w);height:var(--box-h);border:2px solid #000;margin:8px auto;border-radius:12px;padding:8px;text-align:left;overflow-y:auto;background:#fff}
    .box .winner-row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:4px 6px}
    .box .winner-name{flex:1 1 auto;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .box .winner-stats{flex:0 0 auto;color:#6B6620;font-weight:700;white-space:nowrap;text-align:right}
    .card > div:last-of-type > button{font-size:20px;padding:15px 20px;border-radius:20px}
    #copy-btn{font-size:15px;padding:10px 18px;line-height:1;min-width:180px;border-radius:10px}

    /* 추첨 오버레이(스피너) */
    #overlay{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;pointer-events:none;transition:opacity .2s ease,visibility 0s linear .2s}
    #overlay.show{opacity:1;visibility:visible;pointer-events:auto;transition:opacity .2s ease}
    #overlay .panel{border-radius:20px;padding:16px 18px;background-image:var(--grad,linear-gradient(135deg,#44D446,#2C472C));box-shadow:0 18px 50px rgba(0,0,0,.45),inset 0 0 0 1px rgba(255,255,255,.06)}
    #overlay .chip{display:inline-block;margin:0 auto 8px;font-weight:800;font-size:12px;letter-spacing:.3px;background:#1b2330;color:#e6edf3;border-radius:999px;padding:6px 10px;text-transform:uppercase}
    #canvasWrap{position:relative;width:560px;height:200px;border-radius:16px;background:linear-gradient(180deg,#10161c,#0e141a);box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);overflow:hidden}

    /* 랭크 팝업 모달 */
    #rankModal{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9998;display:none;align-items:center;justify-content:center;padding:24px}
    #rankModal.show{display:flex}
    .modal-card{background:#fff;max-width:1100px;width:95vw;max-height:85vh;border-radius:14px;box-shadow:0 18px 40px rgba(0,0,0,.35);display:flex;flex-direction:column;overflow:hidden}
    .modal-header{padding:12px 16px;border-bottom:1px solid #eaeef2;display:flex;align-items:center;justify-content:space-between}
    .modal-title{font-weight:800;font-size:18px}
    .modal-close{appearance:none;border:0;background:transparent;font-size:22px;line-height:1;padding:8px 10px;cursor:pointer}
    .modal-body{
      background:#fff;           /* 스크롤 컨테이너 자체도 불투명 */
      position: relative;
    }
    
    /* 헤더 위를 막는 천장 레이어 */
    .table-ceiling{
      position: sticky;
      top: 0;
      height: 8px;               /* 필요시 6~12px 조정 */
      background: #fff;          /* 완전 불투명 */
      z-index: 4;                /* 헤더(th)보다 위 */
      margin-top: -8px;          /* 위쪽 경계에 딱 붙게 */
    }
    
    /* sticky 헤더는 그 아래에 배치 */
    thead th{
      background:#f6f8fa;
      position: sticky;
      top: 0;
      z-index: 3;
    }
    table{
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      font-size: 14px;
    }
    th,td{
      border:1px solid #e1e4e8;
      padding:8px 10px;
      text-align:middle;
      white-space:nowrap;
      background: #fff;
    }
    th{
      background:#f6f8fa;
      position:sticky;
      top:0;
      z-index:2;
      box-shadow: 0 1px 0 rgba(0,0,0,0.04);
    }
    .sticky-col{ 
      position: sticky; 
      left: 0; 
      z-index: 1; 
      background: #fff; 
    }
    .sticky-col-head{ 
      left: 0; 
      z-index: 3;                 /* 헤더가 바디보다 위로 */
      background: #f6f8fa;
      box-shadow: 1px 0 0 rgba(0,0,0,0.06);
    }
    
    /* 승리 열 오른쪽 두꺼운 경계선(승리 열에 붙임) */
    .sep-right{
      border-right-width: 3px !important;
      border-right-color: #0d4015 !important;
    }
    
    /* 1회/2회/... 열: 승리 텍스트 강조 */
    .extra-col.win-cell{
      background: #fff8d6;        /* 연한 노란색 */
    }
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .badge.unrank{background:#d9f2d9}
    .badge.bronze{background:#eadcc5}
    .badge.silver{background:#e3e3e3}
    .badge.gold{background:#efe59d}

    @media (max-width:1200px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:640px){ .grid{grid-template-columns:repeat(1,1fr)} :root{--box-w:86vw} }
  </style>
</head>
<body class="notranslate">
  <h2>힙합 랭겜 추첨기</h2>

  <!-- 시트 열기 -->
  <div class="actions">
    <button class="btn" id="open-sheet-btn">시트 열기</button>
  </div>

  <div id="status">⏳ 부팅 중…</div>
  <div id="meta"></div>

  <div class="grid">
    <div class="card">
      <div class="title" data-rank="언랭"><span>언랭</span><span class="sub">(지원/참여/승리)</span></div>
      <div id="count-언랭" class="count">(당첨: 0명 / 남음: 0명)</div>
      <div id="box-언랭" class="box"></div>
      <div>
        <button id="btn-언랭" onclick="pick('언랭')" disabled>뽑기!</button>
        <button id="reset-언랭" onclick="resetRank('언랭')" disabled>리셋</button>
      </div>
    </div>

    <div class="card">
      <div class="title" data-rank="브론즈"><span>브론즈</span><span class="sub">(지원/참여/승리)</span></div>
      <div id="count-브론즈" class="count">(당첨: 0명 / 남음: 0명)</div>
      <div id="box-브론즈" class="box"></div>
      <div>
        <button id="btn-브론즈" onclick="pick('브론즈')" disabled>뽑기!</button>
        <button id="reset-브론즈" onclick="resetRank('브론즈')" disabled>리셋</button>
      </div>
    </div>

    <div class="card">
      <div class="title" data-rank="실버"><span>실버</span><span class="sub">(지원/참여/승리)</span></div>
      <div id="count-실버" class="count">(당첨: 0명 / 남음: 0명)</div>
      <div id="box-실버" class="box"></div>
      <div>
        <button id="btn-실버" onclick="pick('실버')" disabled>뽑기!</button>
        <button id="reset-실버" onclick="resetRank('실버')" disabled>리셋</button>
      </div>
    </div>

    <div class="card">
      <div class="title" data-rank="골드"><span>골드</span><span class="sub">(지원/참여/승리)</span></div>
      <div id="count-골드" class="count">(당첨: 0명 / 남음: 0명)</div>
      <div id="box-골드" class="box"></div>
      <div>
        <button id="btn-골드" onclick="pick('골드')" disabled>뽑기!</button>
        <button id="reset-골드" onclick="resetRank('골드')" disabled>리셋</button>
      </div>
    </div>
  </div>

  <div style="margin:10px 0 8px;">
    <button id="copy-btn" class="btn" onclick="copyWinners()" disabled>클립보드로 복사</button>
  </div>

  <!-- 추첨 오버레이 -->
  <div id="overlay">
    <div class="panel">
      <div id="tierChip" class="chip"></div>
      <div id="canvasWrap"><canvas id="wheelCanvas" width="560" height="200"></canvas></div>
    </div>
  </div>

  <!-- 랭크 팝업 -->
  <div id="rankModal">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title" id="rankModalTitle">참여자 리스트</div>
        <button class="modal-close" id="rankModalClose" aria-label="닫기">✕</button>
      </div>
      <div class="modal-body">
        <div id="rankTableWrap"></div>
      </div>
    </div>
  </div>

  <!-- 효과음: 결과 시점에만 재생 -->
  <audio id="ding" src="./assets/ding.mp3" preload="none"></audio>

<script>
/* ===== 설정(GAS 웹앱) — /exec URL로 교체 ===== */
const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxXag4ZYrj1ttorbmcyEiZY_b82fVqNAI7RPWfukrQe4hxBnSTU2rCJyX_xVp4wIiDgsw/exec';

/* 시트 열기 버튼용(필수 아님): GAS가 응답에 sheetId를 넘겨줌. */
let SHEET_ID_FROM_GAS = null;

/* ===== 전역 상태 ===== */
const RANKS=['언랭','브론즈','실버','골드'];
let pool={언랭:[],브론즈:[],실버:[],골드:[]};
let selected={언랭:[],브론즈:[],실버:[],골드:[]};
let memberStats={};
/* 참여자 리스트 원본 테이블 */
let statsHeader = [];
let statsRows   = [];

/* ===== helpers ===== */
const $=id=>document.getElementById(id);
const setStatus=(m,e)=>{const el=$('status'); if(!el) return; el.className=e?'status-err':'status-ok'; el.textContent=m;};
const html=(id,h)=>{const el=$(id); if(el) el.innerHTML=h;};
const append=(id,h)=>{const el=$(id); if(el) el.insertAdjacentHTML('beforeend',h);};
const dis=(id,v)=>{const el=$(id); if(el) el.disabled=!!v;};
const esc=s=>String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
function fmtStats(name){ const st=memberStats[name]||{apply:0,part:0,win:0}; return `${st.apply||0}/${st.part||0}/${st.win||0}`; }
function renderRow(name){ const safe=esc(name); return `<div class="winner-row"><span class="winner-name"><b>${safe}</b></span><span class="winner-stats">(${fmtStats(name)})</span></div>`; }
function updateCounts(rank){ const p=(selected[rank]||[]).length; const r=Math.max(0,(pool[rank]?.length||0)-p); html('count-'+rank,`(당첨: ${p}명 / 남음: ${r}명)`); }
function totalWinners(){return RANKS.reduce((s,r)=>s+(selected[r]?.length||0),0)}
function copyWinners(){ if(totalWinners()===0){ setStatus('복사할 당첨자가 없습니다.',true); return; }
  const lines=[]; for(const r of RANKS){ const arr=selected[r]||[]; if(!arr.length) continue; lines.push(r,'------------',...arr.map(n=>`${n}`),''); }
  const txt=lines.join('\n').trim(); if(navigator.clipboard?.writeText){ navigator.clipboard.writeText(txt).then(()=>setStatus('✅ 복사 완료',false)).catch(()=>alert(txt)); } else alert(txt);
}

/* 이름/등급 표준화 & 필터 */
function _norm(s){ return String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim(); }
function rankNorm(s){ s=_norm(s).toLowerCase(); if(/언랭|unrank/.test(s))return '언랭'; if(/브론즈|bronze/.test(s))return '브론즈'; if(/실버|silver/.test(s))return '실버'; if(/골드|gold/.test(s))return '골드'; return ''; }

/* ===== 스피너 ===== */
function gradByRank(rank){ switch(rank){ case '브론즈':return 'linear-gradient(135deg,#968768,#524937)'; case '실버':return 'linear-gradient(135deg,#BABABA,#616060)'; case '골드':return 'linear-gradient(135deg,#D1C432,#827810)'; default:return 'linear-gradient(135deg,#44D446,#2C472C)'; } }
function setupCanvas(canvas){ const dpr=Math.max(1,window.devicePixelRatio||1); const rect=canvas.getBoundingClientRect(); canvas.style.width=rect.width+'px'; canvas.style.height=rect.height+'px'; canvas.width=Math.round(rect.width*dpr); canvas.height=Math.round(rect.height*dpr); const ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.imageSmoothingEnabled=true; return { ctx, w:rect.width, h:rect.height }; }
function drawName(ctx, text, cx, cy, maxW, targetH, weight=900){ let lo=14, hi=Math.min(targetH,64), best=lo; ctx.save(); ctx.textBaseline='middle'; ctx.textAlign='center'; while(lo<=hi){ const mid=(lo+hi)>>1; ctx.font=`normal ${weight} ${mid}px Arial, "Noto Sans KR", sans-serif`; const w=ctx.measureText(text).width; if(w<=maxW){best=mid; lo=mid+1;} else hi=mid-1; } ctx.font=`normal ${weight} ${best}px Arial, "Noto Sans KR", sans-serif`; ctx.fillText(text,Math.round(cx)+0.5,Math.round(cy)+0.5); ctx.restore(); }
let LAST_SPIN_MODE=null; function pickStopMode(){ const modes=['exact','nudgeForward','nudgeBackward']; let m=modes[Math.floor(Math.random()*modes.length)]; if(m===LAST_SPIN_MODE) m=modes[(modes.indexOf(m)+1)%modes.length]; LAST_SPIN_MODE=m; return m; }
function canvasSpin(names, winner, opts, onDone){
  const overlay=$('overlay'); const canvas=$('wheelCanvas'); const { ctx, w, h }=setupCanvas(canvas);
  const centerY=h/2, rowH=opts.rowH||40, gap=opts.gap||12, step=rowH+gap;
  const accelMs=opts.accelMs??500, steadyMs=opts.steadyMs??900, decelMs=opts.decelMs??1100;
  const shakeMs=260, nudgeMs=300, shakeAmp=8; const easeOutCubic=t=>1-Math.pow(1-t,3);
  const L=Math.max(1,names.length), startIdx=Math.floor(Math.random()*L), winIdx=names.indexOf(winner);
  const mode=pickStopMode(); let preIdx=winIdx, nudgeDir=0; if(mode==='nudgeForward'){ preIdx=(winIdx-1+L)%L; nudgeDir=+1; } if(mode==='nudgeBackward'){ preIdx=(winIdx+1)%L; nudgeDir=-1; }
  const cycles=4, idxDiffPre=((preIdx-startIdx)%L+L)%L, baseTotalShift=(cycles*L+idxDiffPre)*step;
  const spinTotal=accelMs+steadyMs+decelMs, extraTotal=(nudgeDir===0?0:(shakeMs+nudgeMs));
  function drawCenterGuides(){ ctx.save(); ctx.strokeStyle='rgba(255,255,255,0.18)'; ctx.lineWidth=1; const pad=12, yA=Math.round(centerY-step/2)+0.5, yB=Math.round(centerY+step/2)+0.5; ctx.beginPath(); ctx.moveTo(pad,yA); ctx.lineTo(w-pad,yA); ctx.moveTo(pad,yB); ctx.lineTo(w-pad,yB); ctx.stroke(); ctx.restore(); }
  function renderFrame(now,t0){ const t=now-t0; let dist=0;
    if(t<=spinTotal){ if(t<=accelMs){ dist=baseTotalShift*(t/accelMs*0.2); } else if(t<=accelMs+steadyMs){ dist=baseTotalShift*(0.2+0.5*((t-accelMs)/steadyMs)); } else { dist=baseTotalShift*(0.7+0.3*easeOutCubic(Math.min(1,(t-accelMs-steadyMs)/decelMs))); } }
    else if(nudgeDir!==0 && t<=spinTotal+shakeMs){ dist=baseTotalShift+Math.sin(((t-spinTotal)/shakeMs)*Math.PI*2.0)*shakeAmp; }
    else if(nudgeDir!==0 && t<=spinTotal+shakeMs+nudgeMs){ dist=baseTotalShift+(nudgeDir*step)*easeOutCubic(Math.min(1,(t-spinTotal-shakeMs)/nudgeMs)); }
    else { dist=baseTotalShift+(nudgeDir*step); }
    ctx.clearRect(0,0,w,h); const shiftRows=dist/step, baseIdx=Math.floor(shiftRows), frac=shiftRows-baseIdx;
    for(let k=-3;k<=+3;k++){ const idx=(startIdx+baseIdx+k+L)%L; const name=names[idx]; const y=centerY-(k-frac)*step; const ady=Math.abs(k-frac);
      let scale=0.6, alpha=0.45; if(ady<=0.5){ scale=1.0; alpha=1.0; } else if(ady<=1.5){ scale=0.8; alpha=0.75; }
      ctx.save(); ctx.globalAlpha=alpha; if(scale>=0.95){ ctx.shadowColor='rgba(0,0,0,0.55)'; ctx.shadowBlur=10; ctx.shadowOffsetY=3; } else { ctx.shadowColor='transparent'; ctx.shadowBlur=0; ctx.shadowOffsetY=0; }
      ctx.fillStyle='#fff'; drawName(ctx, name, w/2, y, w*0.86, rowH*scale, 900); ctx.restore();
    }
    drawCenterGuides();
    const endTime=spinTotal+extraTotal;
    if(t<endTime){ requestAnimationFrame(n2=>renderFrame(n2,t0)); }
    else {
      try{ const ding=$('ding'); if(ding){ ding.currentTime=0; ding.play().catch(()=>{}); } }catch(e){}
      setTimeout(()=>{ $('overlay').classList.remove('show'); onDone&&onDone(); }, opts.waitMs ?? 1800);
    }
  }
  requestAnimationFrame(t0=>renderFrame(t0,t0));
}
function showOverlayWithName(rank, winner, done){
  const names=(pool[rank]||[]).map(s=>String(s||'').trim()).filter(Boolean);
  $('overlay').style.setProperty('--grad', gradByRank(rank));
  $('tierChip').textContent=(rank==='브론즈'?'BRONZE':rank==='실버'?'SILVER':rank==='골드'?'GOLD':rank);
  $('overlay').classList.add('show');
  canvasSpin(names.length?names:[winner], String(winner), {accelMs:500,steadyMs:900,decelMs:1100,rowH:40,gap:12,waitMs:1800}, done);
}

/* ===== pick/reset ===== */
function pick(rank){
  try{
    const btn=$('btn-'+rank); if(!btn||btn.disabled) return; btn.disabled=true;
    const remain=(pool[rank]||[]).filter(n=>n && !(selected[rank]||[]).includes(n));
    if(!remain.length){ setStatus(`⚠️ ${rank} 인원이 없습니다.`,true); btn.disabled=false; return; }
    const winner=remain[Math.floor(Math.random()*remain.length)];
    showOverlayWithName(rank, winner, ()=>{
      (selected[rank]=selected[rank]||[]).push(winner);
      append('box-'+rank, renderRow(winner));
      updateCounts(rank);
      const still=(pool[rank]?.length||0)-(selected[rank]?.length||0);
      btn.disabled=(still===0);
      dis('copy-btn', totalWinners()===0);
      setStatus(`${rank} → ${winner} 당첨!`, false);
    });
  }catch(e){ setStatus('❌ pick 오류: '+e,true); }
}
function resetRank(rank){
  selected[rank]=[]; html('box-'+rank,''); updateCounts(rank);
  dis('btn-'+rank,(pool[rank]?.length||0)===0); dis('copy-btn', totalWinners()===0);
  setStatus(`${rank} 리셋 완료`, false);
}
function preReset(){
  setStatus('⏳ 부팅 중…',false); $('meta').textContent='';
  for(const r of RANKS){ html('box-'+r,''); html('count-'+r,'(당첨: 0명 / 남음: 0명)'); dis('btn-'+r,true); dis('reset-'+r,true); }
  dis('copy-btn',true);
}

/* ===== 랭크 팝업 로직 ===== */
function buildRankTable(rank){
  if(!statsHeader.length){ return '<div>참여자 리스트를 불러오지 못했습니다.</div>'; }

  // ① 컬럼 인덱스 수집
  const hdr = statsHeader.map(h => _norm(h));
  const idxName  = hdr.findIndex(h => /^이름$|^name$/i.test(h));
  const idxRank  = hdr.findIndex(h => /^등급$|^랭크$|^rank$/i.test(h));
  const idxApply = hdr.findIndex(h => /^지원$|^apply$/i.test(h));
  const idxPart  = hdr.findIndex(h => /^참여$|^part$/i.test(h));
  const idxWin   = hdr.findIndex(h => /^승리$|^win$/i.test(h));

  // ② "숫자회" 패턴 열 자동 수집 (1회, 2회, 3회, ...)
  const extraIdx = [];
  hdr.forEach((h,i)=>{ if(/^\d+\s*회$/i.test(h)) extraIdx.push(i); });

  // ③ 헤더(th) 구성 (이름은 sticky 고정, 승리 열은 오른쪽 두꺼운 구분선)
  const ths = [];
  if(idxName>=0)  ths.push('<th class="sticky-col-head">이름</th>');
  if(idxRank>=0)  ths.push('<th>등급</th>');
  if(idxApply>=0) ths.push('<th>지원</th>');
  if(idxPart>=0)  ths.push('<th>참여</th>');
  if(idxWin>=0)   ths.push('<th class="sep-right">승리</th>');
  extraIdx.forEach(i => ths.push(`<th>${esc(hdr[i])}</th>`));

  // ④ 행 구성(등급 필터 + 첫 열 sticky + 1회 이후 승리 칸 노란색)
  const rowsHtml = [];
  for(const r of statsRows){
    const rankVal = idxRank>=0 ? r[idxRank] : '';
    if(rank && rankNorm(rankVal)!==rank) continue;

    const tds = [];
    if(idxName>=0)  tds.push(`<td class="sticky-col">${esc(r[idxName]||'')}</td>`);
    if(idxRank>=0){
      const rv = rankNorm(r[idxRank]);
      const badgeClass = rv==='언랭'?'unrank':rv==='브론즈'?'bronze':rv==='실버'?'silver':rv==='골드'?'gold':'';
      tds.push(`<td><span class="badge ${badgeClass}">${esc(r[idxRank]||'')}</span></td>`);
    }
    if(idxApply>=0) tds.push(`<td>${esc(r[idxApply]||'')}</td>`);
    if(idxPart>=0)  tds.push(`<td>${esc(r[idxPart ]||'')}</td>`);
    if(idxWin>=0)   tds.push(`<td class="sep-right">${esc(r[idxWin  ]||'')}</td>`);

    // 1회/2회/... : 텍스트에 '승' 또는 '승리' 포함 시 색 강조
    extraIdx.forEach(i => {
      const val = String(r[i] ?? '');
      const isWin = /승리?|win/i.test(val);
      tds.push(`<td class="extra-col${isWin?' win-cell':''}">${esc(val)}</td>`);
    });

    rowsHtml.push(`<tr>${tds.join('')}</tr>`);
  }

  return `
    <div class="table-ceiling"></div>
    <table>
      <thead><tr>${ths.join('')}</tr></thead>
      <tbody>${
        rowsHtml.join('') || '<tr><td colspan="'+ths.length+'">해당 등급 데이터가 없습니다.</td></tr>'
      }</tbody>
    </table>
  `;
}
function openRankModal(rank){
  $('rankModalTitle').textContent = `참여자 리스트 — ${rank}`;
  $('rankTableWrap').innerHTML = buildRankTable(rank);
  $('rankModal').classList.add('show');
}
function closeRankModal(){ $('rankModal').classList.remove('show'); }

/* ===== 데이터 로드(GAS) ===== */
async function loadData(){
  try{
    const res = await fetch(GAS_ENDPOINT, { cache: 'no-store' });
    if(!res.ok) throw new Error('GAS endpoint HTTP '+res.status);
    const data = await res.json();

    pool = {
      '언랭': Array.isArray(data.pools?.['언랭']) ? data.pools['언랭'] : [],
      '브론즈': Array.isArray(data.pools?.['브론즈']) ? data.pools['브론즈'] : [],
      '실버': Array.isArray(data.pools?.['실버']) ? data.pools['실버'] : [],
      '골드': Array.isArray(data.pools?.['골드']) ? data.pools['골드'] : []
    };
    memberStats = (data.stats && typeof data.stats==='object') ? data.stats : {};
    statsHeader = Array.isArray(data.statsHeader) ? data.statsHeader : [];
    statsRows   = Array.isArray(data.statsRows)   ? data.statsRows   : [];
    SHEET_ID_FROM_GAS = data.sheetId || null;

    for(const r of RANKS){
      const remain=(pool[r]||[]).length;
      html('count-'+r,`(당첨: 0명 / 남음: ${remain}명)`);
      dis('btn-'+r, remain===0);
      dis('reset-'+r,false);
    }
    dis('copy-btn',true);
    setStatus('✅ 준비 완료', false);
  }catch(e){
    setStatus('❌ 데이터 로드 실패: '+ (e.message||e), true);
    console.error(e);
  }
}

/* ===== 부팅 & 이벤트 바인딩 ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  preReset();
  loadData();

  // 시트 열기
  $('open-sheet-btn').addEventListener('click', ()=>{
    const id = SHEET_ID_FROM_GAS;
    if(!id){ setStatus('시트 ID를 찾을 수 없습니다.', true); return; }
    const url = `https://docs.google.com/spreadsheets/d/${id}/edit`;
    window.open(url, '_blank', 'noopener');
  });

  // 타이틀 클릭 → 랭크 팝업
  document.querySelectorAll('.title[data-rank]').forEach(el=>{
    el.addEventListener('click', ()=> openRankModal(el.getAttribute('data-rank')));
  });

  // 팝업 닫기
  $('rankModalClose').addEventListener('click', closeRankModal);
  $('rankModal').addEventListener('click', (e)=>{
    if(e.target.id==='rankModal') closeRankModal(); // 바깥 클릭 닫기
  });
});
</script>
</body>
</html>



